# 澜鳐网关技术文档

## 1. 项目概述

澜鳐网关是一款基于嵌入式系统开发的物联网网关设备，用于连接各类物联网设备，实现向下无线设备控制，向上可供澜鳐终端软件连接。该网关仿照智能家居网关设计，支持公网连接（通过内网穿透）和纯局域网连接两种模式，适用于有网络连接的远程控制场景和无网络连接的保密环境。

### 1.1 主要功能

- **设备连接管理**：支持多种无线协议（WiFi、BLE、Zigbee等）连接物联网设备
- **内网穿透**：与云服务器建立稳定连接，获得固定公网访问地址
- **设备控制**：接收终端指令，转发给目标设备并返回执行结果
- **状态监控**：实时采集设备状态数据，上传至云服务器或本地终端
- **本地计算**：支持边缘计算，实现设备数据的本地处理与分析
- **双模式运行**：支持公网连接和纯局域网连接两种模式
- **安全认证**：设备接入认证、数据加密传输、访问权限控制

### 1.2 应用场景

- **远程监控**：通过公网实现对设备的远程控制与监控
- **实验室环境**：纯局域网模式，满足主机不得联网的保密要求
- **工业自动化**：连接各类工业设备，实现集中控制与管理
- **智能家居**：连接智能家居设备，提供统一的控制入口

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                       澜鳐终端软件                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   设备控制      │  │   状态监控      │  │   日志管理      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       澜鳐云服务器                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   网关管理      │  │   设备注册      │  │   内网穿透      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       澜鳐物联网网关                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   路由器模块    │  │   网关核心      │  │   无线通信      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       物联网设备集群                              │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件关系

| 组件 | 功能 | 通信协议 |
|------|------|----------|
| 澜鳐终端 | 设备控制界面、状态监控、日志查询 | TCP/IP、WebSocket |
| 澜鳐云服务器 | 网关注册、设备管理、内网穿透 | TCP/IP、HTTP/HTTPS |
| 澜鳐网关 | 设备连接、指令转发、状态采集 | WiFi、BLE、Zigbee、TCP/IP |
| 物联网设备 | 执行指令、采集数据、返回结果 | 各类无线协议 |

## 3. 网关硬件设计

### 3.1 硬件架构

| 模块 | 型号/规格 | 功能 |
|------|----------|------|
| 主控芯片 | ESP32-S3 | 核心计算单元，运行网关固件 |
| 无线模块 | ESP32内置WiFi/BLE | 提供WiFi和BLE通信能力 |
| Zigbee模块 | CC2530 | 支持Zigbee设备连接 |
| 以太网接口 | LAN8720 | 提供有线网络连接 |
| 电源模块 | 5V/2A | 为网关和外接设备供电 |
| 存储模块 | 16MB Flash + 8MB PSRAM | 存储固件和运行时数据 |
| LED指示灯 | 3个 | 指示电源、网络连接、设备状态 |

### 3.2 接口设计

| 接口类型 | 数量 | 功能 |
|----------|------|------|
| 以太网口 | 1个 | 有线网络连接 |
| USB接口 | 2个 | 设备调试和外接设备扩展 |
| GPIO | 16个 | 支持外接传感器和执行器 |
| UART | 2个 | 串行通信接口 |
| I2C | 1个 | 支持I2C设备连接 |
| SPI | 1个 | 高速串行通信接口 |

## 4. 网关软件设计

### 4.1 软件架构

```
┌─────────────────────────────────────────────────────────────────┐
│                       应用层                                    │
├─────────────────────────┬─────────────────┬─────────────────┤
│   设备管理模块          │   网关管理模块  │   云服务模块    │
├─────────────────────────┴─────────────────┴─────────────────┤
│                       中间层                                    │
├─────────────────────────┬─────────────────┬─────────────────┤
│   通信协议栈            │   数据处理模块  │   安全认证模块  │
├─────────────────────────┴─────────────────┴─────────────────┤
│                       驱动层                                    │
├─────────────────────────┬─────────────────┬─────────────────┤
│   WiFi驱动             │   BLE驱动       │   Zigbee驱动    │
├─────────────────────────┴─────────────────┴─────────────────┤
│                       硬件抽象层                                │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 核心模块设计

#### 4.2.1 设备管理模块

- **设备发现**：自动扫描并发现支持的无线设备
- **设备注册**：将设备信息注册到本地数据库或云服务器
- **设备状态管理**：实时更新设备状态，处理设备上下线事件
- **设备分组**：支持设备分组管理，实现批量控制

#### 4.2.2 通信协议栈

- **WiFi协议**：支持802.11 b/g/n，提供AP和STA两种模式
- **BLE协议**：支持BLE 5.0，实现低功耗设备连接
- **Zigbee协议**：支持Zigbee 3.0，构建Mesh网络
- **MQTT协议**：与云服务器和终端进行消息通信
- **WebSocket**：实现与终端的实时双向通信

#### 4.2.3 内网穿透模块

- **实现方式**：基于frp或ngrok实现内网穿透
- **连接机制**：主动与云服务器建立TCP连接，保持长连接
- **端口映射**：将网关内部服务端口映射到公网
- **动态域名**：为每个网关分配唯一的二级域名

#### 4.2.4 安全认证模块

- **设备认证**：采用预共享密钥(PSK)或证书认证方式
- **数据加密**：使用AES-128加密传输数据
- **访问控制**：基于角色的访问控制(RBAC)
- **安全审计**：记录所有设备访问日志

## 5. 云服务器设计

### 5.1 服务器架构

```
┌─────────────────────────────────────────────────────────────────┐
│                       负载均衡层                                │
├─────────────────────────────────────────────────────────────────┤
│                       应用服务层                                │
├─────────────────────────┬─────────────────┬─────────────────┤
│   网关管理服务          │   设备管理服务  │   用户管理服务  │
├─────────────────────────┼─────────────────┼─────────────────┤
│   内网穿透服务          │   数据存储服务  │   日志服务      │
├─────────────────────────┴─────────────────┴─────────────────┤
│                       数据存储层                                │
├─────────────────────────┬─────────────────┬─────────────────┤
│   MySQL数据库          │   Redis缓存     │   MongoDB       │
└─────────────────────────┴─────────────────┴─────────────────┘
```

### 5.2 核心服务

#### 5.2.1 网关注册服务

- **功能**：处理网关的注册请求，分配唯一标识符
- **流程**：
  1. 网关启动后向云服务器发送注册请求
  2. 服务器验证网关身份，分配唯一Gateway ID
  3. 服务器记录网关信息，包括型号、版本、网络状态等
  4. 返回注册结果和配置信息

#### 5.2.2 内网穿透服务

- **功能**：为网关提供内网穿透能力，实现公网访问
- **实现方式**：
  1. 云服务器部署frp/ngrok服务端
  2. 网关运行frp/ngrok客户端，主动连接服务器
  3. 建立隧道后，服务器分配固定公网地址
  4. 终端通过公网地址访问网关

#### 5.2.3 设备管理服务

- **功能**：管理所有注册设备的信息
- **设备信息**：设备ID、类型、状态、所属网关、位置等
- **设备映射**：建立设备与网关的映射关系，实现设备的准确定位

## 6. 终端与网关通信机制

### 6.1 通信协议

| 通信场景 | 协议 | 端口 | 用途 |
|----------|------|------|------|
| 终端→网关 | TCP/IP | 8080 | 设备控制指令传输 |
| 网关→终端 | WebSocket | 8081 | 设备状态实时推送 |
| 网关→云服务器 | MQTT | 1883 | 设备数据上传 |
| 云服务器→网关 | MQTT | 1883 | 远程指令下发 |

### 6.2 指令格式

```json
{
  "cmd": "control",
  "device_id": "dev_001",
  "action": "switch",
  "params": {
    "status": "off"
  },
  "timestamp": 1620000000000
}
```

### 6.3 状态上报格式

```json
{
  "device_id": "dev_001",
  "status": "on",
  "data": {
    "power": 12.5,
    "voltage": 220,
    "current": 0.057
  },
  "timestamp": 1620000000000
}
```

## 7. 设备连接流程

### 7.1 设备接入流程

1. **设备通电**：物联网设备通电后进入配对模式
2. **网关扫描**：网关定期扫描周围的无线设备
3. **设备发现**：网关发现新设备，获取设备信息
4. **设备认证**：网关对设备进行身份认证
5. **设备注册**：网关将设备信息注册到本地或云服务器
6. **分配地址**：网关为设备分配唯一的设备ID和通信地址
7. **建立连接**：设备与网关建立稳定的通信连接

### 7.2 功率检测模块接入示例

以功率检测模块与电源开关模块（简称设备1）为例：

1. **硬件连接**：
   - 将设备1连接到信号分发模块
   - 将设备1插入超声仪电源插头与插座之间
   - 信号分发模块通电

2. **自动连接**：
   - 信号分发模块自动搜索并连接到网关路由器
   - 网关为信号分发模块分配固定内网IP地址
   - 设备1通过信号分发模块与网关建立通信

3. **设备注册**：
   - 网关将设备1的信息注册到云服务器
   - 设备1获得唯一的设备ID：dev_power_001
   - 云服务器记录设备1的类型、位置、所属网关等信息

4. **状态采集**：
   - 设备1实时采集超声仪的功率数据
   - 当功率大于1W时，判定为设备开启
   - 当功率小于等于1W时，判定为设备关闭
   - 设备1将状态数据上报给网关

5. **指令执行**：
   - 终端发送关闭设备1电源的指令
   - 网关接收指令，转发给设备1
   - 设备1执行断电操作，断开超声仪电源
   - 设备1返回执行结果给网关，网关再返回给终端

## 8. 双模式运行机制

### 8.1 公网连接模式

**适用场景**：有网络连接的远程控制场景

**工作流程**：
1. 网关通过以太网或WiFi连接到公网
2. 网关主动与云服务器建立TCP连接
3. 云服务器为网关分配固定的公网访问地址
4. 终端通过云服务器访问网关，实现远程控制
5. 设备数据通过网关上传到云服务器，终端从云服务器获取数据

**优势**：
- 支持远程控制，不受地理位置限制
- 数据可长期存储在云服务器，便于历史查询和分析
- 支持多终端同时访问

### 8.2 纯局域网模式

**适用场景**：无网络连接环境或实验室要求主机不得联网的保密环境

**工作流程**：
1. 网关开启AP模式，创建本地WiFi网络
2. 终端连接到网关创建的WiFi网络
3. 网关为终端分配内网IP地址
4. 终端与网关直接通信，实现设备控制和状态监控
5. 所有数据仅在本地传输，不上传到云服务器

**优势**：
- 无需公网连接，满足保密要求
- 通信延迟低，响应速度快
- 不受网络波动影响，可靠性高

## 9. 安全性设计

### 9.1 设备安全

- **设备认证**：所有接入网关的设备必须经过身份认证
- **加密通信**：设备与网关之间采用AES-128加密通信
- **访问控制**：基于设备ID的访问权限控制
- **固件更新**：支持安全的固件更新机制，防止恶意篡改

### 9.2 网络安全

- **防火墙**：内置防火墙，防止非法访问
- **入侵检测**：实时检测网络入侵行为
- **数据加密**：网关与云服务器之间采用TLS/SSL加密通信
- **安全审计**：记录所有网络访问日志，便于追溯

### 9.3 应用安全

- **用户认证**：终端用户必须经过身份认证才能访问网关
- **权限管理**：基于角色的访问控制，不同用户拥有不同权限
- **数据隐私**：敏感数据采用加密存储，防止泄露
- **审计日志**：记录所有操作日志，便于审计和追溯

## 10. 网关配置与管理

### 10.1 配置方式

| 配置方式 | 适用场景 | 操作步骤 |
|----------|----------|----------|
| Web配置界面 | 首次配置 | 1. 连接网关WiFi<br>2. 访问192.168.10.1<br>3. 配置网络参数和设备信息 |
| 终端软件配置 | 日常管理 | 1. 打开澜鳐终端软件<br>2. 连接网关<br>3. 在终端软件中配置网关参数 |
| 云平台配置 | 远程管理 | 1. 登录澜鳐云平台<br>2. 选择目标网关<br>3. 远程配置网关参数 |

### 10.2 管理功能

- **设备管理**：添加、删除、编辑设备信息
- **网络配置**：配置WiFi、以太网、Zigbee等网络参数
- **网关状态监控**：查看网关运行状态、CPU使用率、内存使用率等
- **日志管理**：查看网关日志、设备日志、网络日志
- **固件更新**：在线或离线更新网关固件

## 11. 开发与调试

### 11.1 开发环境

| 工具 | 版本 | 用途 |
|------|------|------|
| ESP-IDF | 5.0 | 网关固件开发框架 |
| Arduino IDE | 2.0 | 快速原型开发 |
| VS Code | 1.80 | 代码编辑 |
| PlatformIO | 6.0 | 跨平台开发环境 |
| Wireshark | 4.0 | 网络数据包分析 |

### 11.2 调试接口

- **串口调试**：通过USB转串口工具连接网关，查看调试信息
- **Web调试界面**：提供在线调试工具，支持命令行输入和日志查看
- **远程调试**：通过云服务器实现网关的远程调试

### 11.3 固件更新

| 更新方式 | 适用场景 | 操作步骤 |
|----------|----------|----------|
| OTA更新 | 公网连接模式 | 1. 云服务器上传新固件<br>2. 网关检测到新固件<br>3. 网关自动下载并更新固件 |
| 本地更新 | 纯局域网模式 | 1. 终端软件上传新固件<br>2. 网关接收固件并更新<br>3. 更新完成后重启网关 |
| USB更新 | 开发调试阶段 | 1. 通过USB连接网关<br>2. 使用烧录工具烧录新固件 |

## 12. 部署与维护

### 12.1 部署方式

| 部署场景 | 部署步骤 |
|----------|----------|
| 家庭环境 | 1. 网关通电<br>2. 连接到家庭WiFi<br>3. 终端软件连接网关<br>4. 添加设备 |
| 实验室环境 | 1. 网关通电，开启AP模式<br>2. 终端连接到网关WiFi<br>3. 配置网关参数<br>4. 添加设备 |
| 工业环境 | 1. 网关固定安装<br>2. 连接到工业网络<br>3. 配置网关参数<br>4. 批量添加设备<br>5. 部署终端软件 |

### 12.2 维护与故障排查

| 故障现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 网关无法连接到云服务器 | 1. 网络连接异常<br>2. 云服务器地址配置错误<br>3. 防火墙阻止连接 | 1. 检查网络连接<br>2. 核对云服务器地址<br>3. 配置防火墙规则 |
| 设备无法被网关发现 | 1. 设备未进入配对模式<br>2. 设备与网关距离过远<br>3. 无线信号干扰 | 1. 重启设备进入配对模式<br>2. 缩短设备与网关距离<br>3. 减少无线信号干扰 |
| 终端无法控制设备 | 1. 网关与设备通信故障<br>2. 设备离线<br>3. 指令格式错误 | 1. 重启网关和设备<br>2. 检查设备电源<br>3. 核对指令格式 |
| 网关频繁重启 | 1. 电源不稳定<br>2. 固件异常<br>3. 硬件故障 | 1. 更换稳定电源<br>2. 重新烧录固件<br>3. 更换硬件 |

### 12.3 性能优化

- **设备连接数优化**：根据网关硬件能力，合理控制设备连接数量
- **通信频率优化**：根据设备类型和应用场景，调整数据上报频率
- **内存管理优化**：定期清理内存，防止内存泄漏
- **电源管理优化**：采用低功耗设计，延长网关使用寿命

## 13. 未来规划

### 13.1 功能扩展

- 支持更多无线协议（LoRa、NB-IoT等）
- 增强边缘计算能力，支持更复杂的本地数据处理
- 添加AI算法，实现设备状态预测和故障诊断
- 支持语音控制，提供更便捷的操作方式

### 13.2 性能提升

- 提高设备连接数上限（目标：支持1000+设备连接）
- 降低通信延迟（目标：端到端延迟<100ms）
- 提高网关可靠性（目标：MTBF>10000小时）

### 13.3 安全性增强

- 支持硬件加密芯片，提高数据安全性
- 实现设备指纹识别，防止设备伪造
- 支持区块链技术，实现设备数据的不可篡改

## 14. 附录

### 14.1 网关API接口

| 接口名称 | 方法 | 参数 | 返回值 | 描述 |
|----------|------|------|--------|------|
| 设备列表获取 | GET | 无 | { devices: [] } | 获取网关连接的设备列表 |
| 设备控制 | POST | device_id, action, params | { success: boolean, message: string } | 控制指定设备 |
| 设备状态获取 | GET | device_id | { status: string, data: object } | 获取指定设备的状态 |
| 网关状态获取 | GET | 无 | { status: string, cpu: number, memory: number } | 获取网关运行状态 |
| 网络配置 | POST | type, params | { success: boolean, message: string } | 配置网关网络参数 |

### 14.2 设备通信协议

#### 8.1 WiFi设备通信协议

| 命令 | 格式 | 功能 |
|------|------|------|
| 设备发现 | `AT+SCAN` | 扫描周围的WiFi设备 |
| 设备连接 | `AT+CONNECT=<ssid>,<pwd>` | 连接到指定WiFi网络 |
| 数据发送 | `AT+SEND=<data>` | 发送数据到网关 |
| 数据接收 | `+RECV:<data>` | 接收网关发送的数据 |

#### 8.2 BLE设备通信协议

| UUID | 功能 | 数据格式 |
|------|------|----------|
| 0000fff0-0000-1000-8000-00805f9b34fb | 服务UUID | - |
| 0000fff1-0000-1000-8000-00805f9b34fb | 特征UUID（写） | 指令数据 |
| 0000fff2-0000-1000-8000-00805f9b34fb | 特征UUID（读） | 状态数据 |
| 0000fff3-0000-1000-8000-00805f9b34fb | 特征UUID（通知） | 实时数据 |

### 14.3 术语表

| 术语 | 解释 |
|------|------|
| 网关 | 连接物联网设备和网络的中间设备 |
| 内网穿透 | 将内网设备暴露到公网的技术 |
| 边缘计算 | 在网络边缘节点进行数据处理的计算模式 |
| MQTT | 一种轻量级的消息传输协议 |
| WebSocket | 一种全双工通信协议 |
| AES | 高级加密标准，一种对称加密算法 |
| TLS/SSL | 传输层安全协议，用于加密网络通信 |
| MTBF | 平均无故障时间，衡量设备可靠性的指标 |

## 15. 联系方式

- 项目地址：https://github.com/yourusername/LanYaoGateway
- 问题反馈：https://github.com/yourusername/LanYaoGateway/issues
- 技术支持：support@lanyaogateway.com

---

**文档版本**：v1.0
**发布日期**：2024-01-01
**更新记录**：
- v1.0：初始版本，包含网关硬件设计、软件架构、双模式运行机制等核心内容